<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="scripts/navbar.js"></script>
    <title>Document</title>
</head>
<body class="p-3 m-0 border-0 bd-example m-0 border-0">
    <%- include ('navbar') -%>
    <% if (itemPriceList.length === 0) { %>
        <div class="alert alert-warning mt-5">Add items to your list to view them here and place an order!</div>
    <% } else { %>
    <div class="card w-75 p-3 mx-auto mt-5">
        <div class="card-body" > 
            <h6>Items</h6>
            <div>Price</div>
        </div>
    <ul id="item-list" class="list-group list-group-flush">
    <%- itemPriceList.map((item) => `
        <li class="list-group-item">
            <h6>${item.name}(${item.qty})</h6>
            <div>${item.price}</div>
        </li>
    `).join('') -%>
    </ul>
    <h6 class="card-body">Total : <%= total %></h6>
    <label for="specifications">Special Instructions</label>
    <textarea id="specifications" placeholder="Enter your specifications here" ></textarea>
    <label for="tableno">Table Number</label>
    <input type="number" id="tableno" placeholder="Enter your table number" required>
    <div class="card-body">
        <button id="checkout">Checkout</button>
    </div>
    </div>
    <% } %>
    <script>
        const itemListencoded =`<%= JSON.stringify(itemPriceList) %>`;
        const textarea = document.createElement('textarea');
        textarea.innerHTML = itemListencoded;
        const decoded = textarea.value;
        textarea.remove();
        const itemList = JSON.parse(decoded);
        const total = `<%= total %>`
        console.log(itemList, total);
        if(itemList.length !== 0){
        let checkout = document.getElementById("checkout");
        checkout.addEventListener("click", async () => {
            let table = document.getElementById("tableno").value;
            let spec = document.getElementById("specifications").value;
            console.log(table, spec);
            const tableAvailable = await checkTableStatus(table);
            console.log("Table available: ", tableAvailable);
            if(tableAvailable === true){ 
                const order ={
                    table_no: table,
                    specifications: spec,
                    ordered_time: new Date().toISOString().slice(0, 19).replace('T', ' '),
                    total_fare: total,
                    payment_status: 'pending'
                }
                await fetch('/itemList/order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({order,itemList})
                }).then(response => response.json())
                .then(data => {
                    location.assign(data.redirectTo);
                });

            }
            else{
                alert("Table is not available. Check your table no. again");
            }
            console.log(table);
            console.log(spec);
        });

        let tableno = document.getElementById("tableno");
        tableno.addEventListener("change",async () => {
            let table = document.getElementById("tableno").value;
            let tableStatus = await checkTableStatus(table);
            console.log("Table status at listener: ", tableStatus);
            if(table!=="" &&tableStatus === false){
                alert("Table is not available. Check your table no. again");
            }
        });

        async function checkTableStatus(table){
            let tableStatus = false;
            if(table === "") {
                alert("Table number is required");
            } else if( 1>table&& table> 50){
                alert("Table number must be between 1 and 50");
            } else {
                tableStatus = await fetch(`/itemList/tablestatus/${table}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Table status: ", data.tableStatus);
                    return data.tableStatus;
                });
            }
            return tableStatus;
        }

        async function htmlDecoder(htmlString) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = htmlString;
            const decoded = textarea.value;
            textarea.remove();
            return decoded;
        }
        }
    let itemLink = document.getElementById("item-list");
    itemLink.addEventListener("click",() => { 
        const itemList= localStorage.getItem("itemList") ;
        const itemListObj = itemList ? mapToJson(itemList): "{}";
        document.location.href = `/itemList/${itemListObj}`
    });


    let menuLink= document.getElementById("menu-link");
    menuLink.addEventListener("click",() => { 
        document.location.href = `/menu`
    });

    let ordersLink= document.getElementById("orders-link");
    ordersLink.addEventListener("click",() => { 
        document.location.href = `/orders`
    });

    let adminLink = document.getElementById("admin-link");
    if (adminLink) {
    adminLink.addEventListener("click", () => {
        document.location.href = "/admin";
    });
    }

    let chefLink = document.getElementById("chef-link");
    if (chefLink) {
    chefLink.addEventListener("click", () => {
        document.location.href = "/chef";
    });
    }
    </script>
</body>
</html>